<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mahasiswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      min-height: 100vh;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      transition: 0.3s;
    }
    .sidebar {
      width: 250px; background: #16263d; padding: 1rem;
      display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    }
    .sidebar h2 { text-align: center; color: #7fffd4; margin-bottom: 1rem; }
    .sidebar button {
      background: none; border: none; color: #ccc; padding: 0.7rem;
      text-align: left; cursor: pointer; border-radius: 8px; font-weight: 500;
    }
    .sidebar button:hover, .sidebar button.active {
      background: linear-gradient(45deg, #0072ff, #00c6ff); color: #fff; font-weight: bold;
    }
    .content {
      flex: 1; padding: 2rem; overflow-y: auto;
    }
    .topbar {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;
    }
    .toggle-dark {
      padding: 0.5rem 1rem; background: #7fffd4; color: #000;
      border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .section { display: none; }
    .section.active { display: block; }
    .info-box, input, textarea, select {
      background: rgba(255,255,255,0.08); padding: 1rem;
      margin: 0.7rem 0; border-radius: 12px; color: #fff; border: none; width: 100%;
    }

    /* ‚úÖ Tampilan Khusus Select */
    select.info-box {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: bold;
    }
    select.info-box option {
      background: #16263d;
      color: #fff;
    }

    .btn {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: #fff; border: none; padding: 0.7rem 1.5rem;
      font-size: 1rem; font-weight: 600; border-radius: 10px; cursor: pointer;
    }
    .card-profile {
      text-align: center; background: rgba(255,255,255,0.05);
      padding: 2rem; border-radius: 16px; max-width: 400px; margin: auto;
    }
    .card-profile img { width: 100px; border-radius: 50%; margin-bottom: 1rem; border: 3px solid #7fffd4; }

    table {
      width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05);
    }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ffffff22; }
    th { background: rgba(255,255,255,0.1); }
    .status-badge {
      padding: 4px 10px; border-radius: 10px; font-weight: bold; text-transform: capitalize;
    }
    .status-menunggu { background: #ff9800; color: #fff; }
    .status-proses   { background: #2196f3; color: #fff; }
    .status-selesai  { background: #4caf50; color: #fff; }
    .status-batal    { background: #f44336; color: #fff; }

    .dark-mode { background: #121212; color: #eee; }
    .dark-mode .sidebar { background: #1e1e2f; }
    .dark-mode .info-box, .dark-mode input, .dark-mode textarea, .dark-mode select {
      background: rgba(255,255,255,0.1); color: #fff;
    }
    .dark-mode .toggle-dark { background: #00c6ff; color: #000; }
    .dark-mode select.info-box option {
      background: #2a2a3a;
      color: #7fffd4;
    }

    @media(max-width:768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
      .sidebar button { flex: 1; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>üë®‚Äçüéì Mahasiswa</h2>
    <button onclick="showSection('profil')" class="active">üìÑ Profil</button>
    <button onclick="showSection('riwayat')">üìö Riwayat</button>
    <button onclick="showSection('pesanan')">üìù Pesanan</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>
  <div class="content">
    <div class="topbar">
      <h1>Dashboard</h1>
      <div class="toggle-dark" onclick="toggleTheme()">üåô Mode</div>
    </div>
    <div id="profil" class="section active">
      <div class="card-profile">
        <img src="https://ui-avatars.com/api/?name=Mahasiswa" alt="Foto Mahasiswa">
        <h3 id="nama"></h3>
        <p><strong>NPM:</strong> <span id="npm"></span></p>
        <p><strong>Prodi:</strong> <span id="prodi"></span></p>
        <p><strong>No WA:</strong> <span id="nowa"></span></p>
      </div>
    </div>
    <div id="riwayat" class="section">
      <h2>üìö Riwayat Joki Tugas</h2>
      <input type="text" placeholder="üîç Cari tugas..." class="info-box" oninput="filterRiwayat()" id="searchRiwayat">
      <div class="info-box" id="tabelRiwayat">Memuat data...</div>
    </div>
    <div id="pesanan" class="section">
      <h2>üìù Tambah Pesanan</h2>
      <form id="formPesanan">
        <select id="jenis" class="info-box" required onchange="updateHarga()">
          <option value="">Pilih jenis tugas</option>
          <option value="Makalah">Makalah</option>
          <option value="PPT">PPT</option>
          <option value="PPT Premium">PPT Premium</option>
          <option value="Animacy Adobe Flash">Animacy Adobe Flash</option>
          <option value="Koding">Koding</option>
          <option value="Website">Website</option>
        </select>
        <input id="harga" class="info-box" readonly placeholder="Harga otomatis" />
        <textarea id="deskripsi" class="info-box" placeholder="Deskripsi tugas" required></textarea>
        <input type="date" id="deadline" class="info-box" required />
        <button class="btn" type="submit">Kirim Pesanan</button>
      </form>
      <div class="info-box" id="statusPesanan" style="display:none"></div>
    </div>
  </div>
  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) location.href = "botjokitugas.html";
    document.getElementById("nama").textContent = user.nama;
    document.getElementById("npm").textContent = user.npm;
    document.getElementById("prodi").textContent = user.prodi;
    document.getElementById("nowa").textContent = user.nowa;

    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
      document.querySelector(`.sidebar button[onclick*="${id}"]`).classList.add("active");
      if (id === "riwayat") loadRiwayat();
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle("dark-mode");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }
    if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

    function logout() {
      localStorage.removeItem("user");
      Swal.fire({ icon: 'info', title: 'Logout berhasil', timer: 2000, showConfirmButton: false });
      setTimeout(() => location.href = "botjokitugas.html", 1500);
    }

    function showNotif(icon, title, text = '') {
      Swal.fire({ icon, title, text, toast: true, position: 'top-end', timer: 4000, showConfirmButton: false });
    }

    const hargaMap = {
      "Makalah": 20000, "PPT": 20000, "PPT Premium": 45000,
      "Animacy Adobe Flash": 50000, "Koding": 60000, "Website": 100000
    };
    function updateHarga() {
      const jenis = document.getElementById("jenis").value;
      const harga = hargaMap[jenis] || 0;
      document.getElementById("harga").value = `Rp ${harga.toLocaleString("id-ID")}`;
    }

    async function kirimTelegram(data) {
      const TELEGRAM_BOT_TOKEN = "7686312873:AAFgoSgH-5A8RyB8tJRzjevPlXI0iQMi8uI";
      const CHAT_ID = "8087861371";
      const pesan = `üì• Pesanan Baru\nNama: ${data.nama}\nNPM: ${data.npm}\nProdi: ${data.prodi}\nWA: ${data.nowa}\nJenis: ${data.jenis}\nDeadline: ${data.deadline}\nID: ${data.trackingID}`;
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: CHAT_ID, text: pesan })
      });
    }

    document.getElementById("formPesanan").addEventListener("submit", async e => {
      e.preventDefault();
      const jenis = document.getElementById("jenis").value;
      const deskripsi = document.getElementById("deskripsi").value;
      const deadline = document.getElementById("deadline").value;
      const trackingID = "TRK" + Date.now();
      const data = { trackingID, ...user, jenis, deskripsi, deadline };
      const statusBox = document.getElementById("statusPesanan");
      statusBox.style.display = "block";
      statusBox.textContent = "Mengirim pesanan...";
      try {
        await fetch("https://script.google.com/macros/s/AKfycbw1MIjl1fdn6LovwgbarV919fB3oBM4-eUZjWhbmWrXJcA5rOSgBPPdmc_CjjyNRH-_/exec", {
          method: "POST",
          body: new URLSearchParams({ action: "tambahPesanan", data: JSON.stringify(data) })
        });
        await kirimTelegram(data);
        document.getElementById("formPesanan").reset();
        document.getElementById("harga").value = "";
        statusBox.innerHTML = `‚úÖ Terkirim!<br>ID: ${data.trackingID}`;
        showNotif("success", "Pesanan Terkirim", `ID: ${data.trackingID}`);
        navigator.clipboard.writeText(data.trackingID);
        showSection("riwayat");
      } catch (err) {
        console.error(err);
        statusBox.textContent = "‚ùå Gagal mengirim.";
        showNotif("error", "Gagal Mengirim", "Periksa koneksi atau coba lagi.");
      }
    });

    let semuaRiwayat = [];
    async function loadRiwayat() {
      const box = document.getElementById("tabelRiwayat");
      box.textContent = "Memuat data...";
      try {
        const res = await fetch(`https://script.google.com/macros/s/AKfycbwa56YiuCHxD1vGoiPKclM7B4_JZtuHjFYSp0ffDEz4MlripQRVGjBPGPyw2yMcO6kZHg/exec?action=getRiwayat&npm=${user.npm}`);
        const data = await res.json();
        semuaRiwayat = data;
        if (!Array.isArray(data) || data.length === 0) return box.innerHTML = "<i>Belum ada data.</i>";
        tampilkanRiwayat(data);
      } catch (e) {
        box.innerHTML = "<i>Gagal memuat data.</i>";
        showNotif("error", "Gagal Memuat Riwayat");
      }
    }

    function tampilkanRiwayat(data) {
      let html = "<table><tr><th>ID</th><th>Jenis</th><th>Harga</th><th>Status</th></tr>";
      data.forEach(r => {
        const s = r.status.toLowerCase();
        let cls = "status-menunggu";
        if (s.includes("proses")) cls = "status-proses";
        else if (s.includes("selesai")) cls = "status-selesai";
        else if (s.includes("batal")) cls = "status-batal";
        html += `<tr><td>${r.trackingID}</td><td>${r.jenis}</td><td>${r.deadline}</td><td><span class="status-badge ${cls}">${r.status}</span></td></tr>`;
      });
      html += "</table>";
      document.getElementById("tabelRiwayat").innerHTML = html;
    }

    function filterRiwayat() {
      const q = document.getElementById("searchRiwayat").value.toLowerCase();
      const f = semuaRiwayat.filter(r =>
        r.trackingID.toLowerCase().includes(q) ||
        r.jenis.toLowerCase().includes(q) ||
        r.deadline.toLowerCase().includes(q) ||
        r.status.toLowerCase().includes(q)
      );
      tampilkanRiwayat(f);
    }
  </script>
</body>
</html>
