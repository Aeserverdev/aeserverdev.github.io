<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Mahasiswa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      min-height: 100vh;
      background: linear-gradient(135deg, #e0e0e0, #f9f9f9);
      color: #333;
      transition: background 0.5s ease;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #1e293b;
      color: #fff;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.2);
      transition: background 0.3s;
    }

    .sidebar h2 {
      text-align: center;
      color: #7fffd4;
      margin-bottom: 2rem;
      font-size: 1.6rem;
    }

    .sidebar button {
      background: none;
      border: none;
      color: #ccc;
      padding: 0.8rem 1rem;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .sidebar button:hover,
    .sidebar button.active {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: #fff;
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Konten */
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: #f9f9f9;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .toggle-dark {
      padding: 0.6rem 1.2rem;
      background: #0072ff;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      border: none;
      transition: all 0.3s;
    }

    .toggle-dark:hover {
      background: #0052cc;
      transform: scale(1.05);
    }

    /* Section */
    .section {
      display: none;
      animation: fadeIn 0.6s ease;
    }

    .section.active {
      display: block;
    }

    /* Kartu Profil */
    .card-profile {
      max-width: 420px;
      background: rgba(255,255,255,0.8);
      border-radius: 20px;
      margin: auto;
      padding: 2rem;
      text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      backdrop-filter: blur(12px);
      transition: all 0.4s ease;
    }

    .card-profile:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }

    .card-profile img {
      width: 100px;
      border-radius: 50%;
      margin-bottom: 1rem;
      border: 3px solid #7fffd4;
    }

    /* Form & Box */
    .info-box, input, textarea, select {
      background: rgba(255,255,255,0.95);
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: 0.3s;
      width: 100%;
    }

    .btn {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
      color: #fff;
      padding: 0.8rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
    }

    /* Tabel Umum */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #0072ff;
      color: #fff;
    }

    /* Badge Status */
    .status-badge {
      padding: 5px 12px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
    }
    .status-menunggu { background: #ff9800; }
    .status-proses { background: #2196f3; }
    .status-selesai { background: #4caf50; }
    .status-batal { background: #f44336; }

    /* Riwayat Pembayaran - Styling */
    #pembayaran h2 {
      margin-bottom: 1rem;
      color: #0072ff;
      font-size: 1.5rem;
      font-weight: 600;
    }

    #tabelPembayaran table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
    }

    #tabelPembayaran th, #tabelPembayaran td {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
    }

    #tabelPembayaran th {
      background: #0072ff;
      color: white;
      font-weight: 600;
    }

    #tabelPembayaran tr:hover {
      background-color: #f5f5f5;
    }

    .dark-mode #tabelPembayaran tr:hover {
      background-color: #2a2a2a;
    }

    /* Responsive Tabel HP */
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      tr {
        margin-bottom: 1rem;
      }

      td {
        text-align: right;
        position: relative;
        padding-left: 50%;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 45%;
        padding-left: 15px;
        font-weight: bold;
        text-align: left;
      }
    }

    /* Dark Mode */
    .dark-mode {
      background: #121212;
      color: #f0f0f0;
    }

    .dark-mode .sidebar {
      background: #0d1b2a;
    }

    .dark-mode .content {
      background: #1e1e2e;
    }

    .dark-mode .info-box,
    .dark-mode input,
    .dark-mode textarea,
    .dark-mode select,
    .dark-mode table {
      background: #222;
      color: #eee;
      border-color: #444;
    }

    .dark-mode .card-profile {
      background: rgba(255,255,255,0.05);
      color: #fff;
    }

    .dark-mode th {
      background: #263159;
      color: #7fffd4;
    }

    .dark-mode .btn {
      background: linear-gradient(45deg, #00c6ff, #0072ff);
    }

    /* Responsive Layout */
    @media(max-width:768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        gap: 0;
        overflow-x: auto;
        justify-content: space-around;
      }

      .sidebar button {
        flex: 1;
        text-align: center;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>üë®‚Äçüéì Mahasiswa</h2>
    <button onclick="showSection('profil')" class="active">üìÑ Profil</button>
    <button onclick="showSection('riwayat')">üìö Riwayat</button>
    <button onclick="showSection('pesanan')">üìù Pesanan</button>
    <button onclick="showSection('pembayaran')">üí≥ Pembayaran</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>
  <div class="content">
    <div class="topbar">
      <h1>Dashboard</h1>
      <div class="toggle-dark" onclick="toggleTheme()">üåô Mode</div>
    </div>
    <div id="profil" class="section active">
      <div class="card-profile">
        <img src="https://ui-avatars.com/api/?name=Mahasiswa" alt="Foto Mahasiswa">
        <h3 id="nama"></h3>
        <p><strong>NPM:</strong> <span id="npm"></span></p>
        <p><strong>Prodi:</strong> <span id="prodi"></span></p>
        <p><strong>No WA:</strong> <span id="nowa"></span></p>
      </div>
    </div>

    <div id="riwayat" class="section">
      <h2>üìö Riwayat Joki Tugas</h2>
      <input type="text" placeholder="üîç Cari tugas..." class="info-box" oninput="filterRiwayat()" id="searchRiwayat">
      <div class="info-box" id="tabelRiwayat">Memuat data...</div>
    </div>

    <div id="pesanan" class="section">
      <h2>üìù Tambah Pesanan</h2>
      <form id="formPesanan">
        <div class="info-box">
          <label>Jenis Tugas</label>
          <select id="jenis" required onchange="updateHarga()">
            <option value="">-- Pilih Jenis Tugas --</option>
            <option value="MAKALAH">MAKALAH</option>
            <option value="PPT">PPT</option>
            <option value="PPT PREMIUM">PPT PREMIUM</option>
            <option value="WEBSITE">WEBSITE</option>
            <option value="KODING">KODING</option>
            <option value="ANIMACY">ANIMACY</option>
            <option value="BIKIN APLIKASI">BIKIN APLIKASI</option>
          </select>
        </div>

        <div class="info-box">
          <label>Pilih Admin Joki</label>
          <select id="adminJoki" required>
            <option value="">-- Pilih Admin Joki --</option>
            <option value="RENALDI">RENALDI</option>
            <option value="AFRIZAL">AFRIZAL</option>
            <option value="ABDUL HAKIM">ABDUL HAKIM</option>
            <option value="AIDIL ANWAR">AIDIL ANWAR</option>
        </select>
      </div>

      <div class="info-box">
        <label>Metode Pembayaran</label>
        <input id="metode" readonly>
      </div>

      <div class="info-box" id="infoDana" style="display:none;">
        <strong>Nomor Dana:</strong> <span id="nomorDana"></span>
      </div>

      <div class="info-box">
        <label>Deskripsi</label>
        <textarea id="deskripsi" required></textarea>
      </div>

      <div class="info-box">
        <label>Deadline</label>
        <input type="date" id="deadline" required>
      </div>

      <div class="info-box">
        <label>Harga</label>
        <input id="harga" readonly>
      </div>

      <div class="info-box">
        <label>Upload Bukti Pembayaran (gambar)</label>
        <input type="file" id="bukti" accept="image/*" required>
      </div>

      <div class="info-box">
        <button type="submit" class="btn">üöÄ Kirim Pesanan</button>
      </div>
    </form>

    <div class="info-box" id="statusPesanan" style="display:none"></div>
  </div>

  <div id="pembayaran" class="section">
    <h2>üí≥ Riwayat Pembayaran</h2>
    <input type="text" placeholder="üîç Cari pembayaran..." class="info-box" oninput="filterPembayaran()" id="searchPembayaran">
    <div class="info-box" id="tabelPembayaran">Memuat data...</div>
  </div>
</div>
<script>
  // Inisialisasi
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) location.href = "botjokitugas.html";
  document.getElementById("nama").textContent = user.nama;
  document.getElementById("npm").textContent = user.npm;
  document.getElementById("prodi").textContent = user.prodi;
  document.getElementById("nowa").textContent = user.nowa;

  function showSection(id) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    document.querySelector(`.sidebar button[onclick*="${id}"]`).classList.add("active");
    if (id === "riwayat") loadRiwayat();
    if (id === "pembayaran") loadPembayaran();
  }

  function toggleTheme() {
    const isDark = document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  }
  if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");

  function logout() {
    localStorage.removeItem("user");
    Swal.fire({ icon: 'info', title: 'Logout berhasil', timer: 2000, showConfirmButton: false });
    setTimeout(() => location.href = "test.html", 1500);
  }

  function showNotif(icon, title, text = '') {
    Swal.fire({ icon, title, text, toast: true, position: 'top-end', timer: 4000, showConfirmButton: false });
  }

  const hargaMap = {
    "MAKALAH": 20000,
    "PPT": 20000,
    "PPT PREMIUM": 45000,
    "WEBSITE": 100000,
    "KODING": 60000,
    "ANIMACY": 50000,
    "BIKIN APLIKASI": 500000
  };

  function updateHarga() {
    const jenis = document.getElementById("jenis").value;
    const harga = hargaMap[jenis] || 0;
    document.getElementById("harga").value = harga ? `Rp ${harga.toLocaleString("id-ID")}` : '';
  }

  async function kirimTelegramDenganGambar(data, file) {
  const TELEGRAM_BOT_TOKEN = "7686312873:AAFgoSgH-5A8RyB8tJRzjevPlXI0iQMi8uI";
  const CHAT_ID = "1002853719892";

  if (!file || !file.type.startsWith("image/")) {
    throw new Error("File tidak valid. Harus berupa gambar.");
  }

  const formData = new FormData();
  const pesan = `
üì• *Pesanan Baru Masuk*
üë§ Nama: *${data.nama}*
üéì NPM: *${data.npm}*
üè´ Prodi: *${data.prodi}*
üì± WhatsApp: *${data.nowa}*
üìù Jenis Tugas: *${data.jenis}*
üìÑ Deskripsi: *${data.deskripsi}*
üóì Deadline: *${data.deadline}*
üë®‚Äçüè´ Admin Joki: *${data.adminJoki}*
üí≥ Metode Pembayaran: *${data.metode}*
üì± Nomor Dana: *${data.dana}*
üí∞ Harga: *${data.harga}*
üÜî Tracking ID: *${data.trackingID}*
`.trim();

  formData.append("chat_id", CHAT_ID);
  formData.append("caption", pesan);
  formData.append("photo", file);
  formData.append("parse_mode", "Markdown");

  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;
  const response = await fetch(url, {
    method: "POST",
    body: formData
  });

  if (!response.ok) {
    const errText = await response.text();
    throw new Error(`Telegram Error: ${errText}`);
  }
}


  document.getElementById("formPesanan").addEventListener("submit", async e => {
    e.preventDefault();

    const jenis = document.getElementById("jenis").value.trim();
    const adminJoki = document.getElementById("adminJoki").value.trim();
    const deskripsi = document.getElementById("deskripsi").value.trim();
    const deadline = document.getElementById("deadline").value;
    const metode = document.getElementById("metode").value;
    const harga = document.getElementById("harga").value;
    const trackingID = "TRK" + Date.now();
    const fileInput = document.getElementById("bukti");
    const file = fileInput.files[0];

    if (!file) {
      return showNotif("error", "Upload Gagal", "Mohon unggah bukti pembayaran berupa gambar.");
    }

    const data = {
      trackingID,
      nama: user.nama,
      npm: user.npm,
      prodi: user.prodi,
      nowa: user.nowa,
      jenis,
      deskripsi,
      deadline,
      metode,
      harga,
      adminJoki,
      dana: nomorDanaMap[adminJoki] || "-"
    };

    const statusPesanan = document.getElementById("statusPesanan");
    statusPesanan.style.display = "block";
    statusPesanan.innerText = "üì° Mengirim pesanan ke Telegram...";

    try {
      await kirimTelegramDenganGambar(data, file);
      document.getElementById("formPesanan").reset();
      statusPesanan.innerHTML = `‚úÖ Pesanan & bukti berhasil dikirim!<br><strong>ID:</strong> ${trackingID}`;
      navigator.clipboard.writeText(trackingID);
      showNotif("success", "Terkirim!", `Tracking ID: ${trackingID}`);
    } catch (error) {
      statusPesanan.innerHTML = "‚ùå Gagal mengirim ke Telegram.<br>Silakan coba lagi.";
      showNotif("error", "Gagal", error.message);
    }
  });

  let semuaRiwayat = [];
  async function loadRiwayat() {
    const box = document.getElementById("tabelRiwayat");
    box.textContent = "Memuat data...";
    try {
      const res = await fetch(`https://script.google.com/macros/s/AKfycbzvm0RO0IdDk9dgowz7d56ZjOQUejBxjkiUzyOBaRAq5bbmQuLKoGa55sx_DCVW-ghd/exec?action=getRiwayat&npm=${user.npm}`);
      const data = await res.json();
      semuaRiwayat = data;
      if (!Array.isArray(data) || data.length === 0) return box.innerHTML = "<i>Belum ada data.</i>";
      tampilkanRiwayat(data);
    } catch (e) {
      box.innerHTML = "<i>Gagal memuat data.</i>";
      showNotif("error", "Gagal Memuat Riwayat");
    }
  }

  function tampilkanRiwayat(data) {
    let html = "<table><tr><th>ID</th><th>Jenis</th><th>Deadline</th><th>Status</th></tr>";
    data.forEach(r => {
      const s = (r.status || "Menunggu").toLowerCase();
      let cls = "status-menunggu";
      if (s.includes("proses")) cls = "status-proses";
      else if (s.includes("selesai")) cls = "status-selesai";
      else if (s.includes("batal")) cls = "status-batal";
      html += `<tr><td>${r.trackingID || '-'}</td><td>${r.jenis || '-'}</td><td>${r.deadline || '-'}</td><td><span class="status-badge ${cls}">${r.status || 'Menunggu'}</span></td></tr>`;
    });
    html += "</table>";
    document.getElementById("tabelRiwayat").innerHTML = html;
  }

  function filterRiwayat() {
    const q = document.getElementById("searchRiwayat").value.toLowerCase();
    const f = semuaRiwayat.filter(r =>
      r.trackingID.toLowerCase().includes(q) ||
      r.jenis.toLowerCase().includes(q) ||
      r.deadline.toLowerCase().includes(q) ||
      r.status.toLowerCase().includes(q)
    );
    tampilkanRiwayat(f);
  }

  let semuaPembayaran = [];
  async function loadPembayaran() {
    const box = document.getElementById("tabelPembayaran");
    box.textContent = "Memuat data...";
    try {
      const res = await fetch(`https://script.google.com/macros/s/AKfycbzvm0RO0IdDk9dgowz7d56ZjOQUejBxjkiUzyOBaRAq5bbmQuLKoGa55sx_DCVW-ghd/exec?action=getPembayaran&npm=${user.npm}`);
      const data = await res.json();
      semuaPembayaran = data;
      if (!Array.isArray(data) || data.length === 0) return box.innerHTML = "<i>Belum ada data pembayaran.</i>";
      tampilkanPembayaran(data);
    } catch (e) {
      box.innerHTML = "<i>Gagal memuat data pembayaran.</i>";
      showNotif("error", "Gagal Memuat Pembayaran");
    }
  }

  function tampilkanPembayaran(data) {
    let html = "<table><tr><th>ID</th><th>Tanggal</th><th>Metode</th><th>Jumlah</th><th>Status</th></tr>";
    data.forEach(p => {
      const s = (p.status || "Pending").toLowerCase();
      let cls = "status-menunggu";
      if (s.includes("terverifikasi")) cls = "status-selesai";
      else if (s.includes("gagal")) cls = "status-batal";
      html += `<tr><td>${p.id || '-'}</td><td>${p.tanggal || '-'}</td><td>${p.metode || '-'}</td><td>Rp ${parseInt(p.jumlah || 0).toLocaleString("id-ID")}</td><td><span class="status-badge ${cls}">${p.status || 'Pending'}</span></td></tr>`;
    });
    html += "</table>";
    document.getElementById("tabelPembayaran").innerHTML = html;
  }

  function filterPembayaran() {
    const q = document.getElementById("searchPembayaran").value.toLowerCase();
    const f = semuaPembayaran.filter(p =>
      p.id.toLowerCase().includes(q) ||
      p.tanggal.toLowerCase().includes(q) ||
      p.metode.toLowerCase().includes(q) ||
      p.status.toLowerCase().includes(q)
    );
    tampilkanPembayaran(f);
  }

  const nomorDanaMap = {
    "RENALDI": "081348722325",
    "AFRIZAL": "085182489261",
    "ABDUL HAKIM": "085764534425",
    "AIDIL ANWAR": "082279458613"
  };

  document.getElementById("adminJoki").addEventListener("change", function () {
    const admin = this.value;
    const nomor = nomorDanaMap[admin];
    const metodeInput = document.getElementById("metode");
    const danaBox = document.getElementById("infoDana");

    if (nomor) {
      metodeInput.value = "Dana";
      danaBox.style.display = "block";
      document.getElementById("nomorDana").textContent = nomor;
    } else {
      metodeInput.value = "";
      danaBox.style.display = "none";
      document.getElementById("nomorDana").textContent = "";
    }
  });
</script>
</body>
</html>
